# 分布式

当计算机的程序和数据通过网络分布在多于一台计算机上时，计算就成为分布式的。

## 幂等性

对于同一个系统，使用同样的条件，一次请求和重复的多次请求对系统资源的影响是一致的。

_注意：_

1. _幂等不仅只是一次（或多次）请求对资源没有副作用（如查询数据库操作，没有增删改），还包括第一次请求的时候对资源产生了副作用，但是以后的多次请求都不会再对资源产生副作用；_
2. _幂等关注的是以后的多次请求是否对资源产生副作用，而不关注结果；_
3. _网络超时等问题不是幂等的讨论范围。_

幂等性是系统服务对外的一种承诺（而非实现），承诺只要调用接口成功，外部多次调用对系统的影响是一致的。声明为幂等的服务会认为外部调用失败是常态，并且失败之后必有重试。

使用幂等性最大之优势在于使接口保证任何幂等性操作，免去因重试等造成系统产生未知的问题。

如何保证幂等：

1. 数据库乐观锁

    适用于执行更新操作过程，使用版本号实现。
2. 防重token

    针对客户端连续点击或者调用方的超时重试等情况，防止重复提交。调用方在调用接口时先向后端请求一个全局ID，请求时携带该全局ID一起请求，后端需要以该token作为key、用户信息作为value到Redis中进行键值内容校验，若key存在且value匹配就执行删除命令，然后正常执行后面的业务逻辑，若不存在对应的key或value不匹配就返回重复执行之错误信息。
3. 下游传递唯一序列号

    ***TODO***

4. 数据库唯一主键

    主要利用数据库中主键唯一约束的特性，比较适合用于插入时的幂等性，其能保证一张表中只能存在一条带该唯一主键的记录。使用分布式ID充当主键而不是数据库自增主键，这样才能保证在分布式环境下ID的全局唯一性。

**引入幂等后对系统产生的影响**

幂等是为了简化客户端逻辑处理，能放置重复提交等操作，但却增加了服务端的逻辑复杂性和成本，其主要是：

- 把并行执行的功能改为串行执行，降低了执行效率
- 增加了额外控制幂等的业务逻辑，复杂化了业务功能

所以在使用时需考虑是否引入幂等性的必要性，根据实际业务场景具体分析，除了业务上的特殊要求外，一般情况下不需要引入幂等性。

## 分布式锁

当多个进程不在同一系统中，用分布式锁控制多个进程对资源的访问。在传统单机部署下，可以使用Java并发处理相关的API进行互斥控制。但在分布式系统中，由于系统多进程、多线程且分布在不同机器上，原单机并发的控制锁策略失效。

为保证分布式锁可用，需要分布式锁满足以下条件：

1. 互斥：任一时刻只能有一个客户端获取到锁，不能有两个客户端同时获取到锁；
2. 安全：锁只能由持有该锁的客户端删除，不能被其他客户端删除；
3. 容错：当某些节点宕机时，客户端仍能获取到锁；
4. 死锁：获取锁的客户端因某些原因无法释放锁，其他客户端再无法获取到锁。

### 分布式锁的实现

1. 数据库乐观锁

2. Redis

    - 加锁：基于Redis命令：`SET key value NX EX max-lock-time`
    - 解锁：使用Lua脚本

3. ZooKeeper

## 分布式事务

***TODO***

## 集群

***TODO***

## 微服务

***TODO***

## RPC

远程过程调用（Remote Procedure Call），通过网络从远程计算机上请求服务，而不需要了解底层网络技术的协议。RPC假定某些协议存在，如TCP/UDP等，为通信程序之间携带信息数据。

### RPC实现

采用客户端-服务端的模式，通过request-response消息模式实现。

RPC双端通信过程：

1. 建立通信：客户端与服务端建立网络通信连接；
2. 服务寻址：提供远程主机地址以及特定端口，指定调用的方法或函数的名称及出入参的信息；
3. 网络传输：对象要在网络传输需经过序列化和反序列化过程；
4. 服务调用：服务端经过本地调用（代理方式）得到返回值。

### Dubbo

***TODO***

### Spring Cloud

***TODO***

## 服务发现与注册

***TODO***

### ZooKeeper

ZooKeeper是一个开放源码的分布式协调服务，它是集群的管理者，监视着集群中各个节点的状态，根据节点提交的反馈进行下一步合理的操作，最终将简单易用的接口和性能高效、功能稳定的系统提供给用户。

分布式应用程序可以基于ZooKeeper实现诸如数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、master选举、分布式锁和分布式队列等。

ZooKeeper保证了分布式一致性特性：

- 顺序一致性
- 原子性
- 单一视图
- 可靠性
- 实时性（最终一致性）

#### 部署模式

1. 单机部署：一台集群上运行
2. 集群部署：多台集群运行
3. 伪集群部署：一台集群启动多个ZooKeeper实例运行

#### 节点

ZooKeeper提供了一个多层级的节点命名空间（称为znode）。与文件系统不同的是，这些节点都可以设置关联的数据，而文件系统中只有文件节点可以存放数据而目录节点不行。

ZooKeeper为了保证高吞吐和低延迟，在内存中维护了这个树状的目录结构，这种特性使得ZooKeeper不能用于存放大量的数据，每个节点的存放数据上限为1M。

**节点类型**

1. 持久节点（PERSISTENT）：除非手动删除，否则节点一直存在于ZooKeeper上
2. 临时节点（EPHEMERAL）：生命周期与客户端会话绑定，一旦客户端会话失效（客户端与ZooKeeper断开不一定会话失效），那么这个客户端创建的所有临时节点都会被移除
3. 持久顺序节点（PERSISTENT_SEQUENTIAL）：基本特性同持久节点，增加了顺序属性，节点名后边会增加一个由父节点维护的自增整型数字
4. 临时顺序节点（EPHEMERAL_SEQUENTIAL）：基本特性同临时节点，增加了顺序属性，节点名后边会增加一个由父节点维护的自增整型数字

#### 服务器

**角色**

- Leader

  1. 事务请求的唯一调度和处理者，保证集群事务处理的顺序性
  2. 集群内部各服务的调度者
- Follower

  1. 处理客户端的非事务请求，转发事务请求给leader服务器
  2. 参与事务请求proposal的投票
  3. 参与leader选举投票
- Observer（3.0版本以后引入的一个服务器角色）

  1. 在不影响集群事务处理能力的基础上提升集群的非事务处理能力
  2. 处理客户端的非事务请求，转发事务请求给leader服务器
  3. 不参与任何形式的投票

**工作状态**

1. LOOKING：寻找leader状态，当服务器处于该状态时，它会认为当前集群中没有leader，因此需要进入leader选举状态
2. FOLLOWING：跟随者状态，表明当前服务器角色是follower
3. LEADING：领导者状态，表明当前服务器角色是leader
4. OBSERVING：观察者状态，表明当前服务器角色是observer

**数据同步**

整个集群完成leader选举之后，learner（follower和observer的统称）回向leader服务器进行注册。当learner向leader完成注册后，进入数据同步环节。

数据同步流程（均以消息传递的方式进行）：

learner向leader注册 --> 数据同步 --> 同步确认

ZooKeeper的数据同步分为4类：

1. 直接差异化同步（DIFF同步）
2. 先回滚再差异化同步（TRUNC+DIFF同步）
3. 仅回滚同步（TRUNC同步）
4. 全量同步（SNAP同步）

在进行数据同步前，leader会完成数据同步初始化：

***TODO***

**主从节点状态同步**

ZooKeeper的核心是原子广播机制，该机制保证了各个server之间的同步。实现该机制的协议唤作Zab协议。该协议有两种模式：

1. 恢复模式：当服务启动或者leader崩溃后，Zab就进入恢复模式，当leader被选举出来，且大多数server和leader的状态同步以后，恢复模式结束，状态同步保证了leader和server具有相同的系统状态；
2. 广播模式：一旦leader已经和大多数的follower进行了同步状态后，它就可以开始广播消息，即进入广播状态，这时当一个server加入ZooKeeper服务中，它会在恢复模式下启动，发现leader，并和leader进行状态同步，待到同步结束，它也参与消息广播；ZooKeeper服务会一直维持在broadcast状态，直到leader崩溃或者leader失去大部分follower支持。

#### 事务

***TODO***

#### 通知机制

***TODO***

#### 宕机处理

_ZooKeeper本身也是集群，推荐配置不少于3台服务器。_

ZooKeeper自身要保证当一个节点宕机时其他节点会继续提供服务。

- 若是一个follower宕机，还有2台服务器提供访问，因为ZooKeeper上的数据是有多个副本的，数据并不会丢失；
- 若是一个leader宕机，ZooKeeper会选出新的leader。

ZooKeeper集群的机制是只要超过半数的节点正常，集群就能正常提供服务。只有在节点挂得太多，只剩一半或不到一半节点能工作，集群才失效。

#### 负载均衡

***TODO***

#### 分布式锁

***TODO***